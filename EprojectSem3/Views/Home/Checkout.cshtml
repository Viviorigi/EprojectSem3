@model DataAccessLayer_DAL.Models.Subscription
@{
	ViewData["Title"] = "Checkout";
	Layout = "~/Views/Shared/_Layout.cshtml";
}
<!-- Breadscrumb Section -->
<div class="breadcrumb-bar">
    <div class="container">
        <div class="row align-items-center text-center">
            <div class="col-md-12 col-12">
                <h2 class="breadcrumb-title">Checkout Membership</h2>
                <nav aria-label="breadcrumb" class="page-breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Check Out</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<!-- /Breadscrumb Section -->
<!-- Profile Content -->
<div class="dashboard-content listing-section ">
	<div class="container">
		<div class="profile-content">
			<div class="messages-form">
				<div class="card">
					<div class="card-header">
						<h4>Subscription Pack</h4>
					</div>
					<div class="card-body">
						<div class="">
							<label class="col-form-label">Name:</label>
							<label class="col-form-label">@Model.Name</label>
						</div>
						<div class="">
							<label class="col-form-label">Price:</label>
							<label class="col-form-label">@Model.Price $</label>
						</div>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-lg-6 col-md-6">
								<div class="form-set formlast-input">
									<label class="col-form-label">Max ADS: </label>
									<label class="col-form-label">@Model.MaxAds</label>
								</div>
							</div>
							<div class="col-lg-6 col-md-6">
								<div class="form-set formlast-input formlast-input-inner">
									<label class="col-form-label">Duration: </label>
									<label class="col-form-label">@Model.Duration days</label>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div id="paypal-button-container" class="m-auto" style="width:1000px;">
				</div>	
			</div>
			</div>
		</div>
	</div>
</div>
<!-- /Profile Content -->

@section Scripts{
	 <script src="https://sandbox.paypal.com/sdk/js?client-id=@ViewBag.PaypalClientId">
	 </script>
	 <script>
		 paypal.Buttons({
			 style: {
				disableMaxWidth:true
			 },
			createOrder() {
				return fetch(`/Cart/create-paypal-order?id=@Model.SubscriptionId`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					}
				})
					.then(response => {
						if (!response.ok) {
							return response.json().then(err => {
								throw err;
							});
						}
						return response.json(); 
					})
					.then(order => {
						return order.id; 
					})
					.catch(err => {
						alert(err.message); 
						throw err; 
					});
			},
			onApprove(data) {
				return fetch(`/Cart/capture-paypal-order?orderID=${data.orderID}&subcriptionId=@Model.SubscriptionId`,{
					method:"POST",
					body: JSON.stringify({
						orderID:data.orderID
					})
				})
					.then((response) => {			
						if (!response.ok) {
							return response.json().then((err) => {
								throw err;
							})
						}
						return response.json();
					})
					.then((details) => {
						if (details && details.payer && details.payer.name) {
							alert(`Transaction completed by ${details.payer.name.given_name}`);
						} else {
							alert("Payer information is unavailable.");
						}
						window.location.href="/Cart/Success"
					})
					.catch(err => {
						alert(err.message)
					})
				
			}

		}).render('#paypal-button-container')
	 </script>
}